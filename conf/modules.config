/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? filename : null }
    ]

    withName: LRGE {
        ext.prefix = { "lrge_${meta.id}" }
        publishDir = [
            path: { "${params.outdir}/${meta.id}/0_reads" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('size.txt') ? "genome_size_lrge.txt" : null }
        ]
        docker {
            containerOptions = '--entrypoint ""'
        }
        singularity {
            entrypoint = false
        }
    }

    withName: 'LJA|FLYE|PBIPA|CANU|HIFIASM|MYLOASM|MINIPOLISH|RAVEN|PLASSEMBLER' {
        errorStrategy = 'ignore'
        publishDir = [
            path: { "${params.outdir}/${meta.id}/2_assemblies" },
            mode: params.publish_dir_mode,
            saveAs: { filename ->
                if (filename.endsWith('chromosome.fasta.gz')) null
                else if (filename.endsWith('.fasta.gz')) filename
                else if (filename.endsWith('.gfa.gz')) filename
               else null
            }
        ]
    }

    withName: LJA {
        ext.prefix = { "lja_${meta.subset_id}" }
    }

    withName: 'FLYE' {
        ext.prefix = { "flye_${meta.subset_id}" }
    }

    withName: 'PBIPA' {
        ext.prefix = { "pbipa_${meta.subset_id}" }
    }

    withName: 'CANU' {
        ext.prefix = { "canu_${meta.subset_id}" }
    }

    withName: 'MYLOASM' {
        ext.args = '--hifi'
        ext.prefix = { "myloasm_${meta.subset_id}" }
    }

    withName: 'MINIPOLISH' {
        ext.prefix = { "minipolish_${meta.subset_id}" }
    }

    withName: 'HIFIASM' {
        ext.args = '-l0 -f0'
        ext.prefix = { "hifiasm_${meta.subset_id}" } // Rename output files with subset ID
    }

    withName: 'RAVEN' {
        ext.prefix = { "raven_${meta.subset_id}" }
    }

    withName: 'PLASSEMBLER' {
        ext.prefix = { "plassembler_${meta.subset_id}" }
    }

    withName: 'MAPQUIK' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/2_assemblies" },
            mode: params.publish_dir_mode,
            saveAs: { filename ->
                if (filename.endsWith('.depth')) filename
                else null
            }
        ]
    }

    withName: 'AUTOCYCLER_SUBSAMPLE' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/1_subsampled_reads" },
            mode: params.publish_dir_mode,
            saveAs: { filename ->
                if (filename.endsWith('.fastq')) null
                else filename
            }
        ]
    }

    withName: 'AUTOCYCLER_RUN' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/3_autocycler" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> 
                 // We want to publish everything under autocycler_out directly to 3_autocycler
                 if (filename.startsWith('autocycler_out/')) {
                     return filename.replaceFirst('autocycler_out/', '')
                 }
                 return null
            }
        ]
    }

    withName: 'MAPQUIK_AC' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/3_autocycler" },
            mode: params.publish_dir_mode,
            saveAs: { filename ->
                if (filename.endsWith('.depth')) filename
                else null
            }
        ]
    }

    withName: 'SYLPH_PROFILE' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}/0_reads" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'SYLPH_ADD_TAXID' {
        errorStrategy = 'ignore'
        memory = 2.GB
        cpus = 1
        publishDir = [
            path: { "${params.outdir}/${meta.id}/0_reads" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'SYLPH_QUERY' {
        ext.prefix = { "${meta.assembler_prefix}_sylph" }
        publishDir = [
            path: { "${params.outdir}/${meta.id}/3_autocycler/taxonomy_sylph_query_gtdbtk" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'SYLPH_ADD_TAXID_ASSEMBLY' {
        errorStrategy = 'ignore'
        memory = 2.GB
        cpus = 1
        ext.prefix = { "${meta.assembler_prefix}_sylph" }
        publishDir = [
            path: { "${params.outdir}/${meta.id}/3_autocycler/taxonomy_sylph_query_gtdbtk" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'UPDATE_META' {
        publishDir = [
            path: { "${params.outdir}/${meta.id}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('meta.json') ? filename : null }
        ]
    }
}
